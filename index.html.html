<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Para ti ‚ù§Ô∏è</title>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;700&family=Pacifico&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --pink-bg: #fff0f5;
            --pink-card: #ffe4e9;
            --pink-dark: #ffb6c6;
            --text-color: #6b4c52;
            --virus-red: #ff6b6b;
            --virus-bg: #2c0005;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--pink-bg);
            background-image: radial-gradient(circle, #ffdde6 10%, transparent 10%), radial-gradient(circle, #ffdde6 10%, transparent 10%);
            background-size: 30px 30px;
            background-position: 0 0, 15px 15px;
            font-family: 'Nunito', sans-serif;
            overflow: hidden;
            user-select: none; 
            touch-action: none;
        }

        /* --- PANTALLA DE INICIO --- */
        #inicio-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--pink-bg);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            flex-direction: column;
            transition: opacity 1s ease;
        }

        .btn-inicio {
            padding: 20px 40px;
            font-size: 1.5em;
            background-color: var(--pink-dark);
            color: white;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            font-family: 'Pacifico', cursive;
            box-shadow: 0 5px 15px rgba(255, 182, 198, 0.6);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        /* --- CONTENIDO DE LA CARTA --- */
        .carta-container {
            background-color: #fff;
            padding: 40px;
            border-radius: 30px;
            box-shadow: 0 10px 25px rgba(255, 182, 198, 0.4);
            text-align: center;
            max-width: 90%;
            width: 450px;
            border: 3px solid var(--pink-card);
            position: relative;
            z-index: 10;
            display: none;
            opacity: 0;
            transition: opacity 1s ease;
        }

        h1 {
            font-family: 'Pacifico', cursive;
            color: var(--text-color);
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        p.intro {
            font-size: 1.2em;
            color: var(--text-color);
            margin-bottom: 25px;
        }

        .animalitos {
            font-size: 80px;
            margin: 20px 0;
            animation: bounce 2s infinite ease-in-out;
        }
        
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-15px); }
        }

        .btn-container {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 30px;
        }

        button {
            padding: 15px 30px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-si {
            background-color: var(--pink-dark);
            color: white;
            box-shadow: 0 5px var(--text-color);
        }
        
        .btn-no {
            background-color: #e0e0e0;
            color: #888;
            box-shadow: 0 5px #999;
        }

        /* --- JUEGO (CANVAS) --- */
        #game-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #87CEEB;
            display: none;
            z-index: 500;
        }

        canvas {
            display: block;
        }

        /* UI del Juego */
        #coin-counter {
            position: absolute;
            top: 20px;
            left: 20px;
            font-family: 'Nunito', sans-serif;
            font-size: 1.8em;
            color: #FFD700;
            font-weight: bold;
            text-shadow: 2px 2px 0px rgba(0,0,0,0.5);
            z-index: 505;
        }

        #game-controls-hint {
            position: absolute;
            bottom: 20px;
            width: 100%;
            text-align: center;
            font-family: 'Nunito', sans-serif;
            color: white;
            font-weight: bold;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.5);
            pointer-events: none;
            z-index: 502;
        }
        
        .mobile-controls {
             display: none;
             position: absolute;
             bottom: 0;
             width: 100%;
             height: 100%;
             z-index: 501;
        }
        .control-side-left { position: absolute; bottom:0; left:0; width: 30%; height: 100%; }
        .control-side-right { position: absolute; bottom:0; right:0; width: 30%; height: 100%; }
        .control-center-jump { position: absolute; top:0; left:30%; width: 40%; height: 100%; }

        /* --- PANTALLA DE CHOQUE --- */
        #crash-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5); 
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 600;
        }
        
        #crash-msg {
            font-family: 'Arial', sans-serif;
            font-weight: bold;
            font-size: 3em;
            color: #ff3333;
            text-shadow: 2px 2px 0px white;
            text-align: center;
        }

        /* --- PANTALLAS OCULTAS --- */
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: none;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            z-index: 1000;
            text-align: center;
            padding: 20px;
            box-sizing: border-box;
        }

        #virus-screen {
            background-color: var(--virus-bg);
            color: var(--virus-red);
            font-family: 'Courier New', Courier, monospace;
            z-index: 2000;
        }
        
        .virus-icon {
            font-size: 100px;
            margin-bottom: 20px;
            animation: glitch 0.2s infinite;
        }

        #success-screen {
            background-color: rgba(255, 240, 245, 0.95);
            color: var(--text-color);
        }

        .invitacion-card {
            background: white;
            padding: 40px;
            border-radius: 20px;
            border: 4px dashed var(--pink-dark);
            max-width: 500px;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        @keyframes popIn {
            from { transform: scale(0.5); opacity: 0; }
            to { transform: scale(1); opacity: 1; }
        }

        .datos-cita {
            text-align: left;
            margin-top: 30px;
            font-size: 1.3em;
            background: var(--pink-bg);
            padding: 20px;
            border-radius: 15px;
        }
        
        @keyframes glitch {
            0% { transform: translate(0); }
            20% { transform: translate(-5px, 5px); }
            40% { transform: translate(-5px, -5px); }
            60% { transform: translate(5px, 5px); }
            80% { transform: translate(5px, -5px); }
            100% { transform: translate(0); }
        }
    </style>
</head>
<body>

    <audio id="musica" loop>
        <source src="cancion.mp3" type="audio/mpeg">
    </audio>
    
    <audio id="audio-sirena">
        <source src="sirena.mp3" type="audio/mpeg">
    </audio>

    <div id="inicio-screen">
        <h1>Hola... üëã</h1>
        <p style="font-size: 1.2em; color: var(--text-color);">Tengo una sorpresa para ti.</p>
        <br>
        <button class="btn-inicio" id="btnComenzar">Abrir Carta üíå</button>
    </div>

    <div class="carta-container" id="carta">
        <h1>¬°Hola mi amor!</h1>
        <p class="intro">He estado pensando mucho y tengo algo importante que preguntarte...</p>
        
        <div class="animalitos">
            üò∫‚ù§Ô∏èüê∂
        </div>
        
        <h2 style="color: var(--pink-dark); margin-top: 30px;">¬øQuieres ser mi San Valent√≠n?</h2>
        
        <div class="btn-container">
            <button class="btn-si" id="btnSi">S√≠, s√≠ quiero! ü•∞</button>
            <button class="btn-no" id="btnNo">No, jam√°s, wakala üôÖüèª‚Äç‚ôÄÔ∏è</button>
        </div>
    </div>

    <div id="game-container">
        <canvas id="gameCanvas"></canvas>
        <div id="coin-counter">ü™ô 0</div>
        
        <div id="crash-overlay">
            <div id="crash-msg">¬°CUIDADO! üí•<br><span style="font-size:0.5em; color:white;">Reintentando...</span></div>
        </div>

        <div id="game-controls-hint">
            <span class="desktop-hint">‚¨ÖÔ∏è Frenar | ‚û°Ô∏è Acelerar | ‚¨ÜÔ∏è o ESPACIO Saltar</span>
            <span class="mobile-hint" style="display:none;">Izq: Frenar | Der: Acelerar | Centro: Saltar</span>
        </div>
        <div class="mobile-controls" id="mobileControlsBtn">
            <div class="control-side-left" id="brakeBtn"></div>
            <div class="control-center-jump" id="jumpBtn"></div>
            <div class="control-side-right" id="gasBtn"></div>
        </div>
    </div>

    <div id="virus-screen" class="overlay">
        <div class="virus-icon">‚ò†Ô∏èüö´‚ò†Ô∏è</div>
        <h2>¬°VIRUS FATAL!</h2>
        <p>HAS ELEGIDO LA OPCI√ìN INCORRECTA.</p>
        <p>Tus archivos se autodestruir√°n en 3... 2... 1...</p>
        <p style="margin-top: 20px; font-size: 0.8em;">(Mentira, pero di que s√≠ ü§∫)</p>
    </div>

    <div id="success-screen" class="overlay">
        <div class="invitacion-card">
            <div style="font-size: 60px;">üèÜüéâüíñ</div>
            <h2 style="font-family: 'Pacifico', cursive;">¬°Llegaste a la meta!</h2>
            <p>Y tambi√©n a mi coraz√≥n. Eres mi San Valent√≠n.</p>
            
            <div class="datos-cita">
                <div>üìÖ 14 de Febrero, 2026</div>
                <div>üìç Es un secreto ü§´</div>
                <div>‚è∞ 1:00 PM</div>
            </div>
            
            <p style="margin-top: 20px;">Te amo. Att: Miguel.</p>
        </div>
    </div>

    <script>
        // --- REFERENCIAS GLOBALES ---
        const musica = document.getElementById('musica');
        const sirena = document.getElementById('audio-sirena');
        const inicioScreen = document.getElementById('inicio-screen');
        const btnComenzar = document.getElementById('btnComenzar');
        const carta = document.getElementById('carta');
        const btnSi = document.getElementById('btnSi');
        const btnNo = document.getElementById('btnNo');
        const virusScreen = document.getElementById('virus-screen');
        const successScreen = document.getElementById('success-screen');
        const gameContainer = document.getElementById('game-container');
        const crashOverlay = document.getElementById('crash-overlay');
        const coinCounter = document.getElementById('coin-counter');
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');

        // --- L√ìGICA INICIAL ---
        btnComenzar.addEventListener('click', function() {
            musica.volume = 0.5;
            musica.play().catch(e => console.log("Error audio:", e));
            inicioScreen.style.opacity = '0';
            setTimeout(() => {
                inicioScreen.style.display = 'none';
                carta.style.display = 'block';
                setTimeout(() => { carta.style.opacity = '1'; }, 50);
            }, 1000);
        });

        // --- BOT√ìN NO ---
        let contadorSirena = 0;
        sirena.addEventListener('ended', function() {
            contadorSirena++;
            if (contadorSirena < 2) {
                this.currentTime = 0;
                this.play();
            }
        });

        btnNo.addEventListener('click', function() {
            virusScreen.style.display = 'flex';
            musica.pause();
            musica.currentTime = 0;
            contadorSirena = 0;
            sirena.volume = 1.0;
            sirena.play().catch(e => console.log("Falta sirena"));
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        });

        // --- BOT√ìN S√ç -> JUEGO ---
        btnSi.addEventListener('click', function() {
            carta.style.display = 'none';
            gameContainer.style.display = 'flex';
            sirena.pause();
            resizeCanvas();
            initGame();
        });

        // ==========================================
        // MOTOR DEL JUEGO
        // ==========================================
        
        let gameState = 'intro'; 
        let worldDistance = 0;
        let finishLine = 75000; // Nivel m√°s largo
        let score = 0;
        
        let moto = {
            x: 100, y: 0,
            vy: 0, vx: 0,
            angle: 0,   
            onGround: false,
            width: 70, height: 40 
        };

        const GRAVITY = 0.6;
        const ACCEL = 0.4;
        const BRAKE = 0.5;
        const MAX_SPEED = 24;
        const FRICTION = 0.98;
        const JUMP_FORCE = -15; 

        let clouds = [];
        let trees = [];
        let obstacles = [];
        let coins = [];
        let input = { gas: false, brake: false, jump: false };

        // CHEAT CODE VARS
        let keySequence = [];

        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
        if (isMobile) {
            document.querySelector('.desktop-hint').style.display = 'none';
            document.querySelector('.mobile-hint').style.display = 'inline';
            document.getElementById('mobileControlsBtn').style.display = 'block';
        }

        window.addEventListener('keydown', e => {
            if (e.key === 'ArrowRight') input.gas = true;
            if (e.key === 'ArrowLeft') input.brake = true;
            if (e.key === 'ArrowUp' || e.code === 'Space') input.jump = true;

            // CHEAT CODE LOGIC
            keySequence.push(e.key.toUpperCase());
            if (keySequence.length > 3) keySequence.shift();
            if (keySequence.join('') === 'JFK') {
                obstacles = []; // Eliminar autos
                worldDistance = finishLine * 0.8; // Teleport al 80%
                console.log("Cheat Activated: JFK");
            }
        });

        window.addEventListener('keyup', e => {
            if (e.key === 'ArrowRight') input.gas = false;
            if (e.key === 'ArrowLeft') input.brake = false;
            if (e.key === 'ArrowUp' || e.code === 'Space') input.jump = false;
        });
        
        const gasBtn = document.getElementById('gasBtn');
        const brakeBtn = document.getElementById('brakeBtn');
        const jumpBtn = document.getElementById('jumpBtn');

        gasBtn.addEventListener('touchstart', e => { e.preventDefault(); input.gas = true; });
        gasBtn.addEventListener('touchend', e => { e.preventDefault(); input.gas = false; });
        brakeBtn.addEventListener('touchstart', e => { e.preventDefault(); input.brake = true; });
        brakeBtn.addEventListener('touchend', e => { e.preventDefault(); input.brake = false; });
        jumpBtn.addEventListener('touchstart', e => { e.preventDefault(); input.jump = true; });
        jumpBtn.addEventListener('touchend', e => { e.preventDefault(); input.jump = false; });

        function resizeCanvas() {
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            // Moto mas a la izquierda para ver m√°s adelante (Zoom out effect)
            moto.x = canvas.width * 0.15; 
        }
        window.addEventListener('resize', resizeCanvas);

        function getGroundY(worldX) {
            let amplitude = canvas.height * 0.1; 
            let hills = Math.sin(worldX * 0.001) * amplitude; 
            let baseLevel = canvas.height * 0.75; 
            return baseLevel - hills;
        }

        // --- DIBUJO ---
        
        function drawBlueMoto(ctx, x, y, angle) {
            ctx.save();
            ctx.translate(x, y - 20); 
            ctx.rotate(angle * 0.5); 
            ctx.scale(0.7, 0.7); // Escala un poco mas peque√±a para el efecto zoom out

            // Ruedas
            ctx.fillStyle = "#333";
            ctx.beginPath(); ctx.arc(-35, 20, 18, 0, Math.PI*2); ctx.fill(); 
            ctx.beginPath(); ctx.arc(35, 20, 18, 0, Math.PI*2); ctx.fill();  
            ctx.fillStyle = "#777";
            ctx.beginPath(); ctx.arc(-35, 20, 8, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(35, 20, 8, 0, Math.PI*2); ctx.fill();

            // Chasis
            ctx.fillStyle = "#0044AA"; 
            ctx.beginPath();
            ctx.moveTo(-30, 10); ctx.lineTo(20, 0); ctx.lineTo(45, 15); 
            ctx.lineTo(35, 30); ctx.lineTo(-25, 30); ctx.closePath();
            ctx.fill();
            ctx.beginPath();
            ctx.moveTo(-15, -5); ctx.lineTo(15, -15); ctx.lineTo(28, 5); ctx.lineTo(-20, 5);
            ctx.fill();
            
            ctx.strokeStyle = "#444"; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.moveTo(25, 0); ctx.lineTo(35, 20); ctx.stroke();

            // Conductora
            ctx.fillStyle = "#888888"; 
            ctx.beginPath();
            ctx.moveTo(-5, -5); ctx.lineTo(15, -15); ctx.lineTo(12, 8); ctx.lineTo(-12, 8);
            ctx.fill();
            
            ctx.fillStyle = "#FFC0CB"; 
            ctx.beginPath(); ctx.arc(5, -20, 13, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#999"; 
            ctx.beginPath(); ctx.ellipse(12, -20, 6, 4, 0, 0, Math.PI*2); ctx.fill();

            ctx.restore();
        }

        function drawMiguel(ctx, x, y) {
            ctx.save();
            ctx.translate(x, y);
            ctx.fillStyle = "black"; ctx.fillRect(-10, -40, 8, 40); ctx.fillRect(2, -40, 8, 40);
            ctx.fillStyle = "#00008B"; ctx.fillRect(-12, -80, 24, 40);
            ctx.fillStyle = "black"; ctx.beginPath(); ctx.arc(0, -90, 14, 0, Math.PI*2); ctx.fill();
            ctx.fillStyle = "#999"; ctx.beginPath(); ctx.ellipse(10, -90, 6, 4, 0, 0, Math.PI*2); ctx.fill();
            ctx.strokeStyle = "#00008B"; ctx.lineWidth = 5;
            ctx.beginPath(); ctx.moveTo(-12, -75); ctx.lineTo(-30, -100); ctx.stroke(); 
            ctx.beginPath(); ctx.moveTo(12, -75); ctx.lineTo(30, -100); ctx.stroke();   
            ctx.strokeStyle = "green"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.moveTo(30, -100); ctx.lineTo(35, -120); ctx.stroke();
            ctx.beginPath(); ctx.moveTo(30, -100); ctx.lineTo(25, -115); ctx.stroke();
            ctx.fillStyle = "red";
            ctx.beginPath(); ctx.arc(35, -120, 5, 0, Math.PI*2); ctx.fill();
            ctx.beginPath(); ctx.arc(25, -115, 5, 0, Math.PI*2); ctx.fill();
            ctx.restore();
        }

        function drawTree(ctx, x, y) {
             ctx.fillStyle = "#8B4513"; ctx.fillRect(x-5, y-40, 10, 40);
             ctx.fillStyle = "#228B22"; 
             ctx.beginPath(); ctx.moveTo(x-30, y-30); ctx.lineTo(x, y-90); ctx.lineTo(x+30, y-30); ctx.fill();
             ctx.beginPath(); ctx.moveTo(x-25, y-50); ctx.lineTo(x, y-100); ctx.lineTo(x+25, y-50); ctx.fill();
        }

        // --- DIBUJO DE OBST√ÅCULOS ---
        function drawVehicle(ctx, x, y, width, height, type, angle) {
            ctx.save();
            ctx.translate(x, y);
            ctx.rotate(angle);
            
            if(type === 'taxi') {
                ctx.fillStyle = "#FDB813"; 
                ctx.fillRect(-width/2, -height, width, height);
                ctx.fillRect(-width/4, -height-12, width/2, 12);
                ctx.fillStyle = "#ADD8E6";
                ctx.fillRect(-width/4 + 5, -height-10, width/2 - 10, 8);
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(-width/3, 0, 10, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(width/3, 0, 10, 0, Math.PI*2); ctx.fill();
                ctx.fillStyle = "#000"; ctx.fillRect(-10, -height-18, 20, 6);
            }
            else if(type === 'car_red' || type === 'car_blue' || type === 'car_green') {
                // Color verde oscuro militar arreglado
                let color = type === 'car_red' ? "#E74C3C" : (type === 'car_blue' ? "#3498DB" : "#1E591E");
                ctx.fillStyle = color;
                ctx.beginPath();
                ctx.moveTo(-width/2, 0); ctx.lineTo(width/2, 0); ctx.lineTo(width/2, -height*0.5); 
                ctx.lineTo(width/4, -height); ctx.lineTo(-width/4, -height); ctx.lineTo(-width/2, -height*0.5);
                ctx.fill();
                ctx.fillStyle = "#CCF";
                ctx.beginPath(); ctx.moveTo(-width/4+5, -height+5); ctx.lineTo(width/4-5, -height+5); 
                ctx.lineTo(width/2-5, -height*0.5); ctx.lineTo(-width/2+5, -height*0.5); ctx.fill();
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(-width/3, 0, 11, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(width/3, 0, 11, 0, Math.PI*2); ctx.fill();
            }
            else if(type === 'bus' || type === 'sitp') {
                ctx.fillStyle = type === 'bus' ? "#C0392B" : "#003399"; 
                ctx.fillRect(-width/2, -height, width, height);
                if(type === 'bus') { // Articulacion Transmi
                    ctx.fillStyle = "#333"; ctx.fillRect(-15, -height, 30, height);
                }
                ctx.fillStyle = "#85C1E9";
                let w = width/2 - 15;
                ctx.fillRect(-width/2 + 10, -height + 15, w-20, height*0.4);
                ctx.fillRect(10, -height + 15, w-20, height*0.4);
                ctx.fillStyle = "black";
                ctx.beginPath(); ctx.arc(-width/2 + 30, 0, 13, 0, Math.PI*2); ctx.fill();
                ctx.beginPath(); ctx.arc(width/2 - 30, 0, 13, 0, Math.PI*2); ctx.fill();
            }
            else if(type === 'bike') {
                ctx.strokeStyle = "#333"; ctx.lineWidth = 2.5;
                ctx.beginPath(); ctx.arc(-width/2 + 10, -10, 15, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); ctx.arc(width/2 - 10, -10, 15, 0, Math.PI*2); ctx.stroke();
                ctx.beginPath(); 
                ctx.moveTo(-width/2+10, -10); 
                ctx.lineTo(-5, -45); 
                ctx.lineTo(15, -45); 
                ctx.lineTo(width/2-10, -10); 
                ctx.stroke();
                ctx.beginPath(); ctx.moveTo(-width/2+10, -10); ctx.lineTo(15, -45); ctx.stroke(); 
                ctx.beginPath(); ctx.moveTo(-10, -45); ctx.lineTo(0, -45); ctx.stroke();
                ctx.beginPath(); ctx.moveTo(15, -45); ctx.lineTo(18, -55); ctx.stroke();
            }

            ctx.restore();
        }

        // Definici√≥n Obst√°culos
        const OBSTACLE_DEFS = [
            { type: 'car_red', width: 100, height: 35, weight: 5 },
            { type: 'car_blue', width: 100, height: 35, weight: 5 },
            { type: 'car_green', width: 100, height: 35, weight: 5 },
            { type: 'sitp', width: 150, height: 70, weight: 4 },
            { type: 'bus', width: 300, height: 85, weight: 2 }, 
            { type: 'taxi', width: 90, height: 40, weight: 2 },
            { type: 'bike', width: 65, height: 50, weight: 1 }
        ];

        let weightedObstacles = [];
        OBSTACLE_DEFS.forEach(obs => {
            for(let i=0; i<obs.weight; i++) weightedObstacles.push(obs);
        });

        function initGame() {
            gameState = 'playing';
            worldDistance = 0; score = 0;
            moto.vx = 0; moto.vy = 0; moto.angle = 0;
            moto.y = getGroundY(moto.x) - 100; 
            crashOverlay.style.display = 'none';
            coinCounter.innerText = "ü™ô " + score;

            clouds = [];
            for(let i=0; i<10; i++) clouds.push({ x: Math.random()*canvas.width, y: Math.random()*canvas.height*0.4, speed: Math.random()*0.5+0.1, size: Math.random()+0.5 });
            
            trees = [];
            for(let i=500; i<finishLine; i+=Math.random()*800+400) trees.push(i);

            obstacles = []; coins = [];
            
            // Generaci√≥n variada
            for(let i = 1500; i < finishLine - 1000; ) {
                let obsTemplate = weightedObstacles[Math.floor(Math.random() * weightedObstacles.length)];
                
                obstacles.push({ x: i, type: obsTemplate.type, width: obsTemplate.width, height: obsTemplate.height });
                
                if(Math.random() > 0.7) {
                    coins.push({ x: i, y_offset: -obsTemplate.height - 120 });
                }
                
                // Gap variable para que no salgan pegados
                let baseGap = 700;
                let variance = Math.random() * 800;
                if(obsTemplate.type === 'bus') baseGap += 300; 
                i += baseGap + variance;
            }
            
            gameLoop();
        }

        function resetLevel() {
            gameState = 'crashed';
            crashOverlay.style.display = 'flex';
            setTimeout(() => { initGame(); }, 2000);
        }

        function gameLoop() {
            if (gameState !== 'playing') return;
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // 1. F√çSICAS
            moto.vy += GRAVITY;
            if (input.gas) moto.vx += ACCEL;
            if (input.brake) moto.vx -= BRAKE;
            moto.vx *= FRICTION;
            if (moto.vx > MAX_SPEED) moto.vx = MAX_SPEED;
            if (moto.vx < -10) moto.vx = -10;
            worldDistance += moto.vx;
            moto.y += moto.vy;

            let currentX = worldDistance + moto.x;
            let groundY = getGroundY(currentX);
            let nextGroundY = getGroundY(currentX + 40);
            let slopeAngle = Math.atan2(nextGroundY - groundY, 40);

            if (moto.y >= groundY) {
                moto.y = groundY;
                moto.vy = 0;
                moto.onGround = true;
                moto.angle = slopeAngle; 
                if (input.jump) { moto.vy = JUMP_FORCE; moto.onGround = false; }
            } else {
                moto.onGround = false;
            }

            // 2. FONDO
            var gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, "#87CEEB"); gradient.addColorStop(1, "#E0F7FA");
            ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.fillStyle = "rgba(255,255,255,0.8)";
            clouds.forEach(c => {
                c.x -= c.speed + (moto.vx * 0.005); if(c.x < -100) c.x = canvas.width + 100;
                ctx.beginPath(); ctx.arc(c.x, c.y, 30*c.size, 0, Math.PI*2); ctx.arc(c.x+40*c.size, c.y, 40*c.size, 0, Math.PI*2); ctx.arc(c.x+80*c.size, c.y, 30*c.size, 0, Math.PI*2); ctx.fill();
            });

            // 3. TERRENO
            ctx.beginPath(); ctx.moveTo(0, canvas.height);
            for (let screenX = -50; screenX <= canvas.width + 50; screenX += 30) ctx.lineTo(screenX, getGroundY(worldDistance + screenX));
            ctx.lineTo(canvas.width + 50, canvas.height); ctx.lineTo(-50, canvas.height);
            ctx.fillStyle = "#7CFC00"; ctx.fill();
            ctx.strokeStyle = "#556B2F"; ctx.lineWidth = 4; ctx.stroke();

            trees.forEach(tx => {
                let sx = (tx - worldDistance) + moto.x;
                if(sx > -100 && sx < canvas.width+100) drawTree(ctx, sx, getGroundY(tx));
            });

            // 4. OBST√ÅCULOS ALINEADOS AL SUELO
            obstacles.forEach(obs => {
                let sx = (obs.x - worldDistance) + moto.x;
                
                // Calcular √°ngulo exacto basado en las ruedas
                let wheelOffset = obs.width * 0.35;
                let groundRear = getGroundY(obs.x - wheelOffset);
                let groundFront = getGroundY(obs.x + wheelOffset);
                let obsAngle = Math.atan2(groundFront - groundRear, wheelOffset * 2);
                let obsY = (groundRear + groundFront) / 2; // Y Promedio para no flotar

                if(sx > -400 && sx < canvas.width+400) {
                    drawVehicle(ctx, sx, obsY, obs.width, obs.height, obs.type, obsAngle);

                    let mx = moto.x; let my = moto.y;
                    let ox = sx; let oy = obsY - obs.height; 
                    
                    if (mx + 20 > ox - obs.width/2 && mx - 20 < ox + obs.width/2) {
                        if (my >= oy && my <= oy + 30 && moto.vy >= 0) {
                             moto.y = oy;
                             moto.vy = 0;
                             moto.onGround = true;
                             moto.angle = obsAngle; 
                             if (input.jump) { moto.vy = JUMP_FORCE; moto.onGround = false; }
                        } else if (my > oy + 30) {
                             resetLevel(); return;
                        }
                    }
                }
            });
            
            // 5. MONEDAS
            coins.forEach((coin, index) => {
                if(coin.collected) return;
                let sx = (coin.x - worldDistance) + moto.x;
                let sy = getGroundY(coin.x) + coin.y_offset;
                if(sx > -50 && sx < canvas.width+50) {
                    ctx.fillStyle = "#FFD700"; ctx.beginPath(); ctx.arc(sx, sy, 15, 0, Math.PI*2); ctx.fill();
                    ctx.strokeStyle = "white"; ctx.lineWidth=2; ctx.stroke(); 
                    ctx.fillStyle = "#B8860B"; ctx.font="bold 16px Arial"; ctx.fillText("$", sx-5, sy+5);

                    let dx = moto.x - sx; let dy = (moto.y-20) - sy;
                    if(Math.sqrt(dx*dx + dy*dy) < 60) {
                        coin.collected = true; score++;
                        coinCounter.innerText = "ü™ô " + score;
                    }
                }
            });

            // 6. META
            if (finishLine - worldDistance < canvas.width + 200) {
                let metaScreenX = (finishLine - worldDistance) + moto.x;
                let metaGroundY = getGroundY(finishLine + moto.x);
                
                // Miguel a la izquierda
                drawMiguel(ctx, metaScreenX - 160, metaGroundY); 

                ctx.fillStyle = "#eee"; 
                ctx.fillRect(metaScreenX+10, metaGroundY-150, 10, 150); 
                ctx.fillRect(metaScreenX-110, metaGroundY-150, 10, 150); 
                
                // Bandera Ajedrez
                let bw = 130; let bh = 40;
                let startX = metaScreenX - 110; let startY = metaGroundY - 150;
                let checkSize = 10;
                for(let r=0; r<bh/checkSize; r++) {
                    for(let c=0; c<bw/checkSize; c++) {
                        ctx.fillStyle = (r+c)%2 === 0 ? "black" : "white";
                        ctx.fillRect(startX + c*checkSize, startY + r*checkSize, checkSize, checkSize);
                    }
                }

                if (moto.x > metaScreenX - 100 && inGameConfetti.length === 0) spawnInGameConfetti(metaScreenX, metaGroundY - 100);
            }
            drawInGameConfetti();

            // 7. MOTO
            drawBlueMoto(ctx, moto.x, moto.y, moto.angle);

            // Barra Progreso
            let progress = Math.min(Math.max(worldDistance / finishLine, 0), 1);
            ctx.fillStyle = "rgba(0,0,0,0.3)"; ctx.fillRect(20, 60, 200, 15);
            ctx.fillStyle = "#FF69B4"; ctx.fillRect(20, 60, 200 * progress, 15);

            if (worldDistance >= finishLine) {
                winGame();
            } else {
                requestAnimationFrame(gameLoop);
            }
        }

        let inGameConfetti = [];
        function spawnInGameConfetti(x, y) {
            const colors = ['#FF69B4', '#FFD700', '#87CEEB', '#FF4500', '#FFF'];
            for(let i=0; i<150; i++) {
                inGameConfetti.push({ x: x, y: y, vx: (Math.random()-0.5)*25, vy: (Math.random()-1)*25, color: colors[Math.floor(Math.random()*colors.length)], size: Math.random()*8+4 });
            }
        }
        function drawInGameConfetti() {
            inGameConfetti.forEach((c, index) => {
                c.x += c.vx; c.y += c.vy; c.vy += 0.8; ctx.fillStyle = c.color; ctx.fillRect(c.x, c.y, c.size, c.size);
                if(c.y > canvas.height + 100) inGameConfetti.splice(index, 1);
            });
        }

        function winGame() {
            gameState = 'won';
            let slowDown = setInterval(() => {
                moto.vx *= 0.8; worldDistance += moto.vx;
                ctx.clearRect(0,0,canvas.width, canvas.height);
                // Dibujo simple final
                var gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
                gradient.addColorStop(0, "#87CEEB"); gradient.addColorStop(1, "#E0F7FA");
                ctx.fillStyle = gradient; ctx.fillRect(0, 0, canvas.width, canvas.height);
                ctx.beginPath(); ctx.moveTo(0, canvas.height);
                 for (let screenX = -50; screenX <= canvas.width + 50; screenX += 30) ctx.lineTo(screenX, getGroundY(worldDistance + screenX));
                ctx.lineTo(canvas.width,canvas.height); ctx.fillStyle="#7CFC00"; ctx.fill();
                
                let metaScreenX = (finishLine - worldDistance) + moto.x;
                let metaGroundY = getGroundY(finishLine + moto.x);
                drawMiguel(ctx, metaScreenX - 160, metaGroundY);
                // Postes final
                ctx.fillStyle = "#eee"; ctx.fillRect(metaScreenX+10, metaGroundY-150, 10, 150); ctx.fillRect(metaScreenX-110, metaGroundY-150, 10, 150); 
                // Ajedrez final
                 let bw = 130; let bh = 40; let startX = metaScreenX - 110; let startY = metaGroundY - 150; let checkSize = 10;
                for(let r=0; r<bh/checkSize; r++) { for(let c=0; c<bw/checkSize; c++) { ctx.fillStyle = (r+c)%2 === 0 ? "black" : "white"; ctx.fillRect(startX + c*checkSize, startY + r*checkSize, checkSize, checkSize); }}
                
                drawBlueMoto(ctx, moto.x, getGroundY(worldDistance+moto.x), 0);
                drawInGameConfetti();
            }, 30);

            setTimeout(() => {
                clearInterval(slowDown);
                gameContainer.style.display = 'none';
                successScreen.style.display = 'flex';
            }, 2500);
        }
    </script>
</body>
</html>